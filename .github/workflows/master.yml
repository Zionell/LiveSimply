name: Nomad workflow

on:
    push:
        branches:
            - master

env:
    GTM: true
    NODE_ENV: production
    SITE_HOST: ${{ vars.SITE_HOST }}
    SITE_URL: ${{ vars.SITE_URL }}
    TLS_MODE: ${{ vars.TLS_MODE }}
    POSTGRES_DB: ${{ vars.POSTGRES_DB }}
    POSTGRES_USER: ${{ vars.POSTGRES_USER }}
    POSTGRES_PASSWORD: ${{ vars.POSTGRES_PASSWORD }}
    POSTGRES_HOST: ${{ vars.POSTGRES_HOST }}
    POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
    POSTGRES_URL: ${{ vars.POSTGRES_URL }}
    CURRENCY_API: ${{ vars.CURRENCY_API }}
    CONVERT_CURRENCY: ${{ vars.CONVERT_CURRENCY }}
    TRANSLATE_API: ${{ vars.TRANSLATE_API }}
    EMAIL_SERVER_USER: ${{ vars.EMAIL_SERVER_USER }}
    EMAIL_SERVER_PASSWORD: ${{ vars.EMAIL_SERVER_PASSWORD }}
    EMAIL_SERVER_HOST: ${{ vars.EMAIL_SERVER_HOST }}
    EMAIL_SERVER_PORT: ${{ vars.EMAIL_SERVER_PORT }}
    EMAIL_FROM: ${{ vars.EMAIL_FROM }}
    JWT_SECRET: ${{ vars.JWT_SECRET }}
    SESSION_SECRET: ${{ vars.SESSION_SECRET }}
    MAGIC_LINK_SECRET: ${{ vars.MAGIC_LINK_SECRET }}
    COOKIES_SECRET: ${{ vars.COOKIES_SECRET }}

jobs:
    #build:
    #  runs-on: ubuntu-latest
    #  steps:
    #    - name: checkout repo
    #      uses: actions/checkout@v3
    #    - name: build frontend
    #      run:  docker-compose -f docker-compose.yml -f docker-compose.frontend.yml build frontend
    #    - name: build backend
    #      run:  docker-compose -f docker-compose.yml -f docker-compose.production.yml build backend
    #    - name: build nginx
    #      run:  docker-compose -f docker-compose.yml -f docker-compose.production.yml build nginx


    #test:
    #  runs-on: ubuntu-latest
    #  needs: build
    #  steps:
    #    - name: checkout repo
    #      uses: actions/checkout@v3
    #    - name: docker compose test
    #      run: docker-compose -f docker-compose.yml -f docker-compose.test.yml run --rm backend /bin/sh -c "pytest -p no:warnings --cov-report term:skip-covered"


    #deploy:
    #  runs-on: self-hosted
    #  needs: build
    #  steps:
    #    - name: checkout repo
    #      uses: actions/checkout@v3
    #    - name: down
    #      run: docker-compose down
    #    - name: prune
    #      run: docker system prune -a
    #    - name: docker compose pull
    #      run: docker-compose -f docker-compose.yml -f docker-compose.production.yml -f docker-compose.frontend.yml pull
    #    - name: docker-compose up
    #      run: docker-compose -f docker-compose.yml -f docker-compose.production.yml -f docker-compose.frontend.yml up --remove-orphans -d


    #prepare-environment:
    #  runs-on: self-hosted
    #  steps:
    #    - name: Stop all
    #      run: docker stop $(docker ps -a -q)
    #    - name: Remove unused data
    #      run: docker system prune -a -f

    deploy:
        runs-on: self-hosted
        #  needs: build
        steps:
            -   name: checkout repo
                uses: actions/checkout@v3
            -   name: docker compose up
                run: docker compose -f docker-compose.yml up --build --remove-orphans -d
